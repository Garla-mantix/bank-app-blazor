@page "/Transfer"
@inject IAccountService AccountService

<PageTitle>Transfer</PageTitle>

<h1>Transfer</h1>

<EditForm Model="_model" OnValidSubmit="SubmitTransferAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="accountfield">
        <label>From Account:</label>
        <InputSelect TValue="Guid" class="inputfield"
                     Value="_model.FromAccountId"
                     ValueChanged="OnFromAccountChanged"
                     ValueExpression="() => _model.FromAccountId">
            <option value="@Guid.Empty">Select from account</option>
            @foreach (var account in _accounts)
            {
                <option value="@account.Id">@account.Name (@account.Balance.ToString("F2") @account.CurrencyType)</option>
            }
        </InputSelect>
    </div>

    <div class="accountfield">
        <label>To Account:</label>
        <InputSelect @key="_model.FromAccountId"
                     TValue="Guid"
                     class="inputfield"
                     Value="_model.ToAccountId"
                     ValueChanged="(Guid v) => _model.ToAccountId = v"
                     ValueExpression="() => _model.ToAccountId"
                     disabled="@(_model.FromAccountId == Guid.Empty)">
            <option value="@Guid.Empty">Choose account</option>
            @foreach (var account in _accounts.Where(a => a.Id != _model.FromAccountId))
            {
                <option value="@account.Id">
                    @account.Name (@account.Balance.ToString("F2") @account.CurrencyType)
                </option>
            }
        </InputSelect>
    </div>

    <div class="accountfield">
        <label>Amount:</label>
        <InputNumber TValue="decimal?" class="inputfield"
                     Value="_model.Amount"
                     ValueChanged="(decimal? v) => _model.Amount = v"
                     ValueExpression="() => _model.Amount" />
    </div>

    <button class="formbutton" type="submit">Transfer</button>
</EditForm>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="accountfield">
        <p class="@(_isSuccess ? "success-message" : "error-message")">@_message</p>
    </div>
}

@code {
    private readonly TransferModel _model = new();
    private List<IBankAccount> _accounts = new();
    private string? _message;
    private bool _isSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccountsAsync();
    }

    private async Task LoadAccountsAsync()
    {
        _accounts = await AccountService.GetAccounts();
    }

    private async Task SubmitTransferAsync()
    {
        if (_model.FromAccountId == Guid.Empty)
        {
            _message = "Please select a source account.";
            _isSuccess = false;
            return;
        }
        if (_model.ToAccountId == Guid.Empty)
        {
            _message = "Please select a destination account.";
            _isSuccess = false;
            return;
        }
        if (_model.FromAccountId == _model.ToAccountId)
        {
            _message = "Cannot transfer to the same account.";
            _isSuccess = false;
            return;
        }
        if (_model.Amount is null or <= 0)
        {
            _message = "Amount must be greater than zero.";
            _isSuccess = false;
            return;
        }

        try
        {
            await AccountService.TransferAsync(_model.FromAccountId, _model.ToAccountId, _model.Amount.Value);

            _message = $"Successfully transferred {_model.Amount:F2}!";
            _isSuccess = true;

            // Refresh balances
            await LoadAccountsAsync();
            
            _model.ToAccountId = Guid.Empty;
            _model.Amount = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
            _isSuccess = false;
        }
    }
    
    private void OnFromAccountChanged(Guid selectedId)
    {
        _model.FromAccountId = selectedId;
        _model.ToAccountId = Guid.Empty;
        StateHasChanged();
    }

    private class TransferModel
    {
        public Guid FromAccountId { get; set; } = Guid.Empty;
        public Guid ToAccountId { get; set; } = Guid.Empty;
        public decimal? Amount { get; set; }
    }
}
